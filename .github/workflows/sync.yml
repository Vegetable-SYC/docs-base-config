name: Multi-Repo Sync
on:
  push:
    branches: [main]
    paths:
      - '.github/target_repos.json'  # ç›‘æ§ä»“åº“åˆ—è¡¨å˜æ›´
      - 'base_conf.py.tpl'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2  # éœ€è¦è·å–å†å²è®°å½•æ¥æ£€æµ‹æ–‡ä»¶å˜åŒ–

      # æ­¥éª¤1ï¼šå®‰è£…ä¾èµ–
      - name: Install dependencies
        run: npm install @octokit/rest node-fetch@2 yaml lodash

      # æ­¥éª¤2ï¼šè¯»å–åŠ¨æ€ä»“åº“åˆ—è¡¨
      - name: Load repo configs
        id: load-config
        run: |
          # ä»é…ç½®æ–‡ä»¶è¯»å–ä»“åº“åˆ—è¡¨ï¼ˆæ”¯æŒJSON/YAMLï¼‰
          if [ -f .github/target_repos.yaml ]; then
            echo "REPO_CONFIG=$(cat .github/target_repos.yaml)" >> $GITHUB_OUTPUT
          elif [ -f .github/target_repos.json ]; then
            echo "REPO_CONFIG=$(cat .github/target_repos.json)" >> $GITHUB_OUTPUT
          else
            echo "âŒ Error: No repo config file found"
            exit 1
          fi

      # æ­¥éª¤3ï¼šæ‰¹é‡è§¦å‘æ›´æ–°
      - name: Trigger Repo Updates
        uses: actions/github-script@v6
        env:
          PAT: ${{ secrets.MASTER_PAT }}
        with:
          script: |
            const { Octokit } = require('@octokit/rest');
            const nodeFetch = require('node-fetch');
            const yaml = require('yaml');
            const _ = require('lodash');

            // åˆå§‹åŒ–å®¢æˆ·ç«¯
            const octokit = new Octokit({
              auth: process.env.PAT,
              request: { fetch: nodeFetch },
              throttle: { enabled: true }  // å¯ç”¨é€Ÿç‡é™åˆ¶å¤„ç†
            });

            // è§£æé…ç½®æ–‡ä»¶
            const configText = `${{ steps.load-config.outputs.REPO_CONFIG }}`;
            const repos = configText.startsWith('{') ? 
              JSON.parse(configText).repositories : 
              yaml.parse(configText).repositories;

            // åˆ†æ‰¹æ¬¡å¤„ç†ï¼ˆæ¯æ‰¹5ä¸ªä»“åº“ï¼Œé—´éš”1ç§’ï¼‰
            const chunks = _.chunk(repos, 5);
            for (const [index, batch] of chunks.entries()) {
              console.log(`ğŸš€ Processing batch ${index + 1}/${chunks.length}`);
              
              await Promise.all(batch.map(async repo => {
                try {
                  const [owner, repoName] = repo.split('/');
                  
                  // é«˜çº§éªŒè¯ï¼šæ£€æŸ¥ä»“åº“æ˜¯å¦å­˜åœ¨
                  const { status } = await octokit.rest.repos.get({
                    owner,
                    repo: repoName
                  });

                  if (status === 200) {
                    await octokit.rest.repos.createDispatchEvent({
                      owner,
                      repo: repoName,
                      event_type: "update-docs-config",
                      headers: {
                        'X-GitHub-Api-Version': '2022-11-28'
                      }
                    });
                    console.log(`âœ… ${repo} è§¦å‘æˆåŠŸ`);
                  }
                } catch (error) {
                  console.error(`âŒ ${repo} å¤±è´¥:`, error.message);
                }
              }));

              // æ‰¹æ¬¡é—´å»¶è¿Ÿ
              if (index < chunks.length - 1) {
                await new Promise(resolve => setTimeout(resolve, 1000));
              }
            }